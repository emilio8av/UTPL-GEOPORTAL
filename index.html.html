<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Geoportal De Aseo - Quito</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    
    body { 
      margin: 0; 
      padding: 0; 
      padding-top: 60px;
      font-family: 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: #f8fafc;
    }
    
    #map { 
      height: 100vh; 
      border-radius: 0;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
    }
    
    /* Header mejorado */
    #titulo-geoportal {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100vw; 
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 1.8rem; 
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 3000; 
      letter-spacing: 1.5px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
    }
    
    #titulo-geoportal::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      pointer-events: none;
    }
    
    /* Panel lateral mejorado */
    .layer-control {
      position: absolute; 
      top: 130px; 
      left: 20px; 
      z-index: 1000;
      background: rgba(255,255,255,0.95); 
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      padding: 24px 20px; 
      font-family: inherit; 
      font-size: 14px;
      min-width: 320px;
      max-width: 380px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .layer-control:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.18);
    }
    
    .header { 
      font-weight: 700; 
      margin-bottom: 16px;
      color: #2d3748;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .header::before {
      content: '\f5fd';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #667eea;
    }
    
    /* Checkboxes mejorados */
    .layer-control label { 
      display: flex; 
      align-items: center;
      margin-bottom: 12px; 
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .layer-control label:hover {
      background: rgba(102, 126, 234, 0.08);
      transform: translateX(4px);
    }
    
    .layer-control input[type="checkbox"] { 
      margin-right: 12px;
      width: 18px;
      height: 18px;
      accent-color: #667eea;
      cursor: pointer;
    }
    
    /* Secci√≥n de filtros mejorada */
    #filtro-panel {
      margin-top: 20px;
      padding: 20px 16px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.04);
    }
    
    #filtro-panel > b {
      color: #2d3748;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    #filtro-panel > b::before {
      content: '\f0b0';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #667eea;
    }
    
    /* Selects mejorados */
    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      transition: all 0.2s ease;
      margin-top: 8px;
      font-family: inherit;
    }
    
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    #filtro-valor-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: white;
    }
    
    #toggle-input-mode:hover {
      background: #5a67d8;
      transform: translateY(-50%) scale(1.05);
    }
    
    /* Botones mejorados */
    .btn-primary {
      padding: 12px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn-primary:hover::before {
      left: 100%;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      padding: 10px 18px;
      background: #718096;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-left: 8px;
    }
    
    .btn-secondary:hover {
      background: #4a5568;
      transform: translateY(-1px);
    }
    
    .btn-success {
      padding: 12px 20px;
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
      margin-top: 8px;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
    }
    
    #btnReportes {
      display: block; 
      margin: 20px auto 0 auto; 
      width: 100%;
      position: relative;
    }
    
    #btnReportes::before {
      content: '\f27a';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-right: 8px;
    }
    
    #btnActualizarReporte {
      display: block; 
      margin: 12px auto 0 auto; 
      width: 100%;
    }
    
    #btnActualizarReporte::before {
      content: '\f2f1';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-right: 8px;
    }
    
    .filter-buttons {
      margin-top: 16px;
      display: flex;
      gap: 8px;
    }
    
    /* Buscador de direcciones */
    .search-container {
      position: absolute;
      top: 80px;
      right: 20px;
      z-index: 1000;
      width: 300px;
    }
    
    .search-box {
      position: relative;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      overflow: visible;
      transition: all 0.3s ease;
    }
    
    .search-box:focus-within {
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    }
    
    .search-input {
      width: 100%;
      padding: 12px 15px 12px 40px;
      border: 2px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: white;
      outline: none;
      color: #2d3748;
      transition: border-color 0.2s ease;
    }
    
    .search-input:focus {
      border-color: #667eea;
    }
    
    .search-input::placeholder {
      color: #a0aec0;
      font-weight: 400;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #667eea;
      font-size: 16px;
      z-index: 1;
    }
    
    .clear-search {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #a0aec0;
      font-size: 14px;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      transition: all 0.2s ease;
      display: none;
    }
    
    .clear-search:hover {
      background: #f7fafc;
      color: #4a5568;
    }
    
    .clear-search.show {
      display: block;
    }
    
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      max-height: 250px;
      overflow-y: auto;
      z-index: 1001;
      display: none;
      margin-top: 4px;
    }
    
    .search-results.show {
      display: block;
    }
    
    .search-result-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #e2e8f0;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .search-result-item:last-child {
      border-bottom: none;
    }
    
    .search-result-item:hover {
      background: #f7fafc;
    }
    
    .search-result-item.selected {
      background: #edf2f7;
    }
    
    .result-icon {
      color: #667eea;
      font-size: 12px;
      width: 14px;
      text-align: center;
    }
    
    .result-text {
      flex: 1;
      min-width: 0;
    }
    
    .result-main {
      font-weight: 500;
      color: #2d3748;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .result-sub {
      color: #718096;
      font-size: 11px;
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .search-loading {
      padding: 12px 15px;
      text-align: center;
      color: #718096;
      font-size: 13px;
    }
    
    .search-no-results {
      padding: 12px 15px;
      text-align: center;
      color: #718096;
      font-size: 13px;
    }
    
    /* Bot√≥n de ubicaci√≥n */
    .location-btn {
      position: fixed;
      top: 80px;
      right: 330px;
      z-index: 1000;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .location-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
    }
    
    .location-btn:active {
      transform: translateY(-1px) scale(0.98);
    }
    
    .location-btn.loading {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Modal mejorado */
    #modalReporte {
      display: none; 
      position: fixed; 
      z-index: 2000; 
      top: 0; 
      left: 0; 
      width: 100vw; 
      height: 100vh;
      background: rgba(0,0,0,0.6); 
      align-items: center; 
      justify-content: center;
      backdrop-filter: blur(8px);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0; 
        transform: translateY(30px) scale(0.95); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }
    
    #formReporte {
      background: white; 
      padding: 32px 28px; 
      min-width: 320px; 
      max-width: 500px;
      width: 90vw;
      border-radius: 20px; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    #formReporte h2 {
      margin: 0 0 24px 0;
      color: #2d3748;
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      position: relative;
    }
    
    #formReporte h2::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }
    
    #formReporte label {
      display: block;
      margin-bottom: 16px;
      color: #4a5568;
      font-weight: 600;
      font-size: 14px;
    }
    
    #formReporte input,
    #formReporte select,
    #formReporte textarea {
      width: 100%;
      padding: 12px 16px;
      margin-top: 6px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
      background: #fafafa;
    }
    
    #formReporte input:focus,
    #formReporte select:focus,
    #formReporte textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: white;
    }
    
    #formReporte textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .form-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    
    .btn-cancel {
      padding: 12px 24px;
      background: #e2e8f0;
      color: #4a5568;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-cancel:hover {
      background: #cbd5e0;
      transform: translateY(-1px);
    }
    
    .btn-submit {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    #msgReporte {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      min-height: 20px;
      transition: all 0.3s ease;
    }
    
    .message-success {
      background: #f0fff4;
      color: #38a169;
      border: 1px solid #9ae6b4;
    }
    
    .message-error {
      background: #fed7d7;
      color: #e53e3e;
      border: 1px solid #feb2b2;
    }
    
    .message-info {
      background: #ebf8ff;
      color: #3182ce;
      border: 1px solid #90cdf4;
    }
    
    @media (max-width: 480px) {
      .search-container {
        width: 200px;
        right: 10px;
      }
      
      .location-btn {
        right: 220px;
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      
      .layer-control {
        top: 135px;
      }
      
      .legend {
        bottom: 15px !important;
        right: 10px !important;
        font-size: 11px !important;
        padding: 12px !important;
        min-width: 180px !important;
        z-index: 9999 !important;
        background: white !important;
        border: 2px solid #e2e8f0 !important;
      }
      
      .legend-item {
        margin-bottom: 6px !important;
      }
      
      .legend-color {
        width: 16px !important;
        height: 16px !important;
      }
      
      .legend-text {
        font-size: 11px !important;
      }
    }
    
    /* Leyenda de geocercas */
    .legend {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 9999;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      padding: 16px;
      font-family: inherit;
      font-size: 12px;
      min-width: 200px;
      border: 2px solid #e2e8f0;
      display: block;
      opacity: 1;
    }
    
    .legend.hidden {
      display: none;
    }
    
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .legend-title {
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 12px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-title::before {
      content: '\f017';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #667eea;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      transition: all 0.2s ease;
    }
    
    .legend-item:last-child {
      margin-bottom: 0;
    }
    
    .legend-item:hover {
      background: rgba(102, 126, 234, 0.05);
      padding: 2px 4px;
      border-radius: 4px;
      margin-left: -4px;
      margin-right: -4px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }
    
    .legend-text {
      color: #4a5568;
      font-weight: 500;
      flex: 1;
      font-size: 12px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .layer-control {
        left: 10px;
        right: 10px;
        top: 125px;
        max-width: none;
        min-width: auto;
      }
      
      .search-container {
        width: 250px;
        top: 75px;
        right: 15px;
      }
      
      .location-btn {
        top: 75px;
        right: 275px;
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      
      #titulo-geoportal {
        font-size: 1.4rem;
        letter-spacing: 1px;
      }
      
      #formReporte {
        padding: 24px 20px;
        margin: 20px;
      }
    }
    
    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #5a67d8;
    }
  </style>
</head>
<body>
<div id="titulo-geoportal">
  <i class="fas fa-map-marked-alt" style="margin-right: 12px;"></i>
  GEOPORTAL DE ASEO - QUITO
</div>

<!-- Buscador de direcciones -->
<div class="search-container">
  <div class="search-box">
    <i class="fas fa-search search-icon"></i>
    <input 
      type="text" 
      class="search-input" 
      id="searchInput" 
      placeholder="Buscar direcci√≥n..."
      autocomplete="off"
    >
    <button class="clear-search" id="clearSearch">
      <i class="fas fa-times"></i>
    </button>
    <div class="search-results" id="searchResults"></div>
  </div>
</div>

<div id="map"></div>

<!-- Bot√≥n de ubicaci√≥n -->
<button id="locationBtn" class="location-btn" title="Ir a mi ubicaci√≥n">
  <i class="fas fa-location-arrow"></i>
</button>

<!-- Leyenda de geocercas -->
<div id="geocercasLegend" class="legend" style="display: block;">
  <div class="legend-title">Horarios y Frecuencias</div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #1e3a8a;"></div>
    <div class="legend-text">Nocturno, L-I-V</div>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #3b82f6;"></div>
    <div class="legend-text">Diurno, L-I-V</div>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #ef4444;"></div>
    <div class="legend-text">Diurno, M-J-S</div>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #991b1b;"></div>
    <div class="legend-text">Nocturno, M-J-S</div>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #059669;"></div>
    <div class="legend-text">Nocturno, Diario</div>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #10b981;"></div>
    <div class="legend-text">Diurno, Diario</div>
  </div>
</div>

<div class="layer-control" id="layerControl">
  <div class="header">Capas Disponibles</div>
  <label>
    <input type="checkbox" id="capa_contenedores">
    <span>üì¶ Contenedores</span>
  </label>
  <label>
    <input type="checkbox" id="capa_barrido">
    <span>üßπ Barrido manual</span>
  </label>
  <label>
    <input type="checkbox" id="capa_geocercas" checked>
    <span>üó∫Ô∏è Geocercas</span>
  </label>
  <label>
    <input type="checkbox" id="capa_islas">
    <span>üèùÔ∏è Islas soterradas</span>
  </label>
  <label>
    <input type="checkbox" id="capa_microrutas">
    <span>üöõ Microrutas</span>
  </label>
  
  <div id="filtro-panel">
    <b>Filtrar por atributo</b>
    <select id="filtro-campo">
      <option value="">Seleccione atributo</option>
      <option value="contenedor">Contenedor (ID)</option>
      <option value="ruta">Ruta</option>
      <option value="hor_frec">Horario/Frecuencia</option>
      <option value="servicio">Servicio</option>
      <option value="adm_zonal">Administraci√≥n Zonal</option>
    </select>
    <div style="position: relative;">
      <select id="filtro-valor">
        <option value="">Seleccione valor</option>
      </select>
      <input type="text" id="filtro-valor-input" placeholder="O escriba el valor..." style="display: none; width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; margin-top: 8px; font-family: inherit; transition: all 0.2s ease;">
      <button type="button" id="toggle-input-mode" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #667eea; color: white; border: none; border-radius: 4px; width: 30px; height: 30px; cursor: pointer; font-size: 12px; display: none; transition: all 0.2s ease;" title="Alternar modo de entrada">
        <i class="fas fa-edit"></i>
      </button>
    </div>
    
    <div class="filter-buttons">
      <button id="btnFiltrar" class="btn-primary">Aplicar</button>
      <button id="btnResetFiltro" class="btn-secondary">Reset</button>
    </div>
    
    <button id="btnReportes" class="btn-primary">Reportes Ciudadanos</button>
    <button id="btnActualizarReporte" class="btn-success">Actualizar Reportes</button>
  </div>
</div>

<!-- Modal de Reportes -->
<div id="modalReporte">
  <form id="formReporte">
    <h2><i class="fas fa-clipboard-list"></i> Reporte Ciudadano</h2>
    
    <label>
      üìÖ Fecha
      <input name="fecha" type="datetime-local" required>
    </label>
    
    <label>
      üë§ Nombre Completo
      <input name="nombre_completo" required>
    </label>
    
    <label>
      üìû Tel√©fono
      <input name="telefono" required>
    </label>
    
    <label>
      üìß Correo electr√≥nico
      <input name="correo_electronico" type="email" required>
    </label>
    
    <label>
      üè∑Ô∏è Tipo de Problema
      <select name="tipo_problema" required>
        <option value="">Seleccione...</option>
        <option>Contenerizado</option>
        <option>Pie de vereda</option>
        <option>Barrido</option>
        <option>Hidrolavado</option>
        <option>Terequez</option>
      </select>
    </label>
    
    <label>
      üìù Descripci√≥n
      <textarea name="descripcion" required placeholder="Describa detalladamente el problema..."></textarea>
    </label>
    
    <label>
      üìç Latitud
      <input name="latitud" type="number" step="any" required>
    </label>
    
    <label>
      üìç Longitud
      <input name="longitud" type="number" step="any" required>
    </label>
    
    <div class="form-buttons">
      <button type="button" id="cerrarModal" class="btn-cancel">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button type="submit" class="btn-submit">
        <i class="fas fa-paper-plane"></i> Enviar
      </button>
    </div>
    
    <div id="msgReporte"></div>
  </form>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
// --- CONFIGURACI√ìN SUPABASE ---
const supabase = window.supabase.createClient(
  'https://ijxzpcyujbwskivhliws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqeHpwY3l1amJ3c2tpdmhsaXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5NTQ3NzMsImV4cCI6MjA2ODUzMDc3M30.19d2qycfTe8Ect_3FXiuaRZyILtgFDdyZawS3DUtHTY'
);

// --- CAPAS ---
const tablas = {
  contenedores: "contenedores",
  barrido_manual: "barrido_manual",
  geocercas: "geocercas",
  islas_soterradas: "islas_soterradas",
  microrutas: "microrutas"
};

// Tablas que se incluyen en los filtros (sin barrido_manual)
const tablasParaFiltros = {
  contenedores: "contenedores",
  geocercas: "geocercas",
  islas_soterradas: "islas_soterradas",
  microrutas: "microrutas"
};

const estilos = {
  contenedores: { color: "#28a745", radius: 6, fillOpacity: 0.8, weight: 2 },
  barrido_manual: { color: "#8B4513", weight: 4, opacity: 0.8 },
  islas_soterradas: { color: "#FFD700", weight: 3, fillOpacity: 0.5, opacity: 0.9 },
  microrutas: { color: "#dc3545", weight: 3, opacity: 0.8 }
};

function colorGeocerca(hor_frec) {
  const colores = {
    "NOCTURNO, L-I-V": "#1e3a8a",
    "DIURNO, L-I-V": "#3b82f6", 
    "DIURNO, M-J-S": "#ef4444",
    "NOCTURNO, M-J-S": "#991b1b",
    "NOCTURNO, DIARIO": "#059669",
    "DIURNO, DIARIO": "#10b981"
  };
  return colores[hor_frec?.toUpperCase?.()] || "#6b7280";
}

// --- FUNCIONES DE GEOMETR√çA (mismo c√≥digo) ---
function WKTtoGeoJSON(wkt) {
  if (typeof wkt !== 'string') return null;
  wkt = wkt.trim();
  let match, coords;
  if ((match = wkt.match(/^POINT Z?\s*\(([-\d\.]+) ([-\d\.]+)(?: [-\d\.]+)?\)$/i))) {
    return { type: "Point", coordinates: [+match[1], +match[2]] };
  } else if ((match = wkt.match(/^LINESTRING Z?\s*\((.+)\)$/i))) {
    coords = match[1].split(',').map(pt=>pt.trim().split(' ').slice(0,2).map(Number));
    return { type: "LineString", coordinates: coords };
  } else if ((match = wkt.match(/^POLYGON Z?\s*\(\((.+)\)\)$/i))) {
    coords = match[1].split(',').map(pt=>pt.trim().split(' ').slice(0,2).map(Number));
    return { type: "Polygon", coordinates: [coords] };
  }
  return null;
}

async function cargarCapa(tabla, estilo, pointAsMarker = false, clasificador = null) {
  let { data, error } = await supabase.from(tabla).select("*");
  if (error || !data) { 
    showMessage('Error cargando ' + tabla + ': ' + (error && error.message ? error.message : ''), 'error');
    return; 
  }
  if (!data.length) {
    showMessage(`La tabla ${tabla} no tiene datos.`, 'info');
    return;
  }
  
  const campoGeom = Object.keys(data[0]).find(k =>
    typeof data[0][k] === "object" && data[0][k] && data[0][k].type && Array.isArray(data[0][k].coordinates)
    || (typeof data[0][k] === "string" && /^(POINT|LINESTRING|POLYGON)/i.test(data[0][k]))
    || (typeof data[0][k] === "string" && data[0][k].includes("coordinates"))
  );
  
  if (!campoGeom) {
    showMessage(`No se detect√≥ campo de geometr√≠a en la tabla ${tabla}.`, 'error');
    return;
  }
  
  let geojson = {
    type: "FeatureCollection",
    features: data.map(row => {
      let geometry;
      const geomField = row[campoGeom];
      if (typeof geomField === "string") {
        try { geometry = JSON.parse(geomField); }
        catch { geometry = WKTtoGeoJSON(geomField); }
      } else if (geomField && typeof geomField === "object" && geomField.type) {
        geometry = geomField;
      }
      if (!geometry || !geometry.type) return null;
      return { type: "Feature", geometry, properties: { ...row } };
    }).filter(f => f)
  };
  
  if (!geojson.features.length) {
    showMessage(`No se pudo leer ninguna geometr√≠a v√°lida en la tabla ${tabla}.`, 'error');
    return;
  }
  
  let capa;
  if (clasificador) {
    capa = L.geoJSON(geojson, {
      style: feature => ({ 
        color: clasificador(feature.properties.hor_frec), 
        weight: 3, 
        fillOpacity: 0.4,
        opacity: 0.8
      }),
      onEachFeature: (feature, layer) => {
        let props = feature.properties;
        let txt = Object.keys(props).map(k => `<b>${k}</b>: ${props[k]}`).join("<br>");
        layer.bindPopup(`<div style="max-width: 250px;">${txt}</div>`);
      }
    });
  } else if (pointAsMarker) {
    capa = L.geoJSON(geojson, {
      pointToLayer: (feature, latlng) =>
        L.circleMarker(latlng, estilo).bindPopup(
          `<div style="max-width: 200px;">
            <b>ID:</b> ${feature.properties.id || ''}<br>
            <b>Ruta:</b> ${feature.properties.ruta || ''}<br>
            <b>Direcci√≥n:</b> ${feature.properties.direccion || ''}
          </div>`
        ),
    });
  } else {
    capa = L.geoJSON(geojson, {
      style: estilo,
      onEachFeature: (feature, layer) => {
        let props = feature.properties;
        let txt = Object.keys(props).map(k => `<b>${k}</b>: ${props[k]}`).join("<br>");
        layer.bindPopup(`<div style="max-width: 250px;">${txt}</div>`);
      }
    });
  }
  return capa;
}

// --- FUNCIONES DE UI ---
function showMessage(text, type = 'info') {
  const msgDiv = document.getElementById('msgReporte');
  msgDiv.textContent = text;
  msgDiv.className = `message-${type}`;
  
  if (type === 'success') {
    setTimeout(() => {
      msgDiv.textContent = '';
      msgDiv.className = '';
    }, 3000);
  }
}

function showLoading(element, text = 'Cargando...') {
  element.innerHTML = `<span class="loading"></span>${text}`;
  element.disabled = true;
}

function hideLoading(element, text) {
  element.innerHTML = text;
  element.disabled = false;
}

// --- INICIALIZAR MAPA Y CAPAS ---
const map = L.map('map').setView([-0.23, -78.52], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

let layers = {};

async function cargarCapas() {
  layers.contenedores = await cargarCapa(tablas.contenedores, estilos.contenedores, true);
  layers.barrido_manual = await cargarCapa(tablas.barrido_manual, estilos.barrido_manual);
  layers.geocercas = await cargarCapa(tablas.geocercas, null, false, colorGeocerca);
  layers.islas_soterradas = await cargarCapa(tablas.islas_soterradas, estilos.islas_soterradas);
  layers.microrutas = await cargarCapa(tablas.microrutas, estilos.microrutas);
  
  Object.keys(layers).forEach(k => {
    if (layers[k]) {
      if (k === "geocercas") map.addLayer(layers[k]);
      else map.removeLayer(layers[k]);
    }
  });
  
  // La leyenda se muestra por defecto ya que geocercas est√° marcado
  console.log('Capas cargadas, leyenda deber√≠a estar visible');
}

// Event listeners para capas
document.getElementById("capa_contenedores").addEventListener("change", e => toggleLayer("contenedores", e.target.checked));
document.getElementById("capa_barrido").addEventListener("change", e => toggleLayer("barrido_manual", e.target.checked));
document.getElementById("capa_geocercas").addEventListener("change", e => {
  toggleLayer("geocercas", e.target.checked);
  toggleLegend(e.target.checked);
});
document.getElementById("capa_islas").addEventListener("change", e => toggleLayer("islas_soterradas", e.target.checked));
document.getElementById("capa_microrutas").addEventListener("change", e => toggleLayer("microrutas", e.target.checked));

function toggleLayer(nombre, visible) {
  if (layers[nombre]) {
    if (visible) map.addLayer(layers[nombre]);
    else map.removeLayer(layers[nombre]);
  }
}

function toggleLegend(show) {
  const legend = document.getElementById('geocercasLegend');
  console.log('Toggle legend:', show, legend); // Para debug
  if (legend) {
    if (show) {
      legend.style.display = 'block';
      legend.classList.remove('hidden');
    } else {
      legend.style.display = 'none';
      legend.classList.add('hidden');
    }
  }
}

cargarCapas();

// =========== FILTRO UNIFICADO POR ATRIBUTO ==============
function limpiarSelect(id, texto) {
  const s = document.getElementById(id);
  s.innerHTML = `<option value="">${texto}</option>`;
}

let inputMode = false; // false = select mode, true = input mode

// Toggle entre select e input
document.getElementById('toggle-input-mode').addEventListener('click', function() {
  const selectEl = document.getElementById('filtro-valor');
  const inputEl = document.getElementById('filtro-valor-input');
  const toggleBtn = document.getElementById('toggle-input-mode');
  
  inputMode = !inputMode;
  
  if (inputMode) {
    selectEl.style.display = 'none';
    inputEl.style.display = 'block';
    toggleBtn.innerHTML = '<i class="fas fa-list"></i>';
    toggleBtn.title = 'Volver a lista desplegable';
    inputEl.focus();
  } else {
    selectEl.style.display = 'block';
    inputEl.style.display = 'none';
    toggleBtn.innerHTML = '<i class="fas fa-edit"></i>';
    toggleBtn.title = 'Escribir valor manualmente';
    inputEl.value = '';
  }
});

// Permitir filtrar con Enter en el input
document.getElementById('filtro-valor-input').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('btnFiltrar').click();
  }
});

document.getElementById('filtro-campo').addEventListener('change', async function() {
  limpiarSelect('filtro-valor', 'Seleccione valor');
  const campo = this.value;
  const toggleBtn = document.getElementById('toggle-input-mode');
  const inputEl = document.getElementById('filtro-valor-input');
  
  if (!campo) {
    toggleBtn.style.display = 'none';
    inputEl.value = '';
    return;
  }
  
  // Mostrar bot√≥n de toggle cuando hay campo seleccionado
  toggleBtn.style.display = 'block';
  
  // Resetear a modo select
  inputMode = false;
  document.getElementById('filtro-valor').style.display = 'block';
  inputEl.style.display = 'none';
  toggleBtn.innerHTML = '<i class="fas fa-edit"></i>';
  toggleBtn.title = 'Escribir valor manualmente';
  inputEl.value = '';

  let valoresUnicos = new Set();
  
  // Si es contenedor, solo buscar en la tabla contenedores
  if (campo === 'contenedor') {
    let { data, error } = await supabase.from('contenedores').select(campo);
    if (error || !data) return;
    data.forEach(d => {
      if (d[campo]) valoresUnicos.add(d[campo]);
    });
  } else {
    // Para otros campos, buscar en todas las tablas del filtro
    for (const t of Object.values(tablasParaFiltros)) {
      let { data, error } = await supabase.from(t).select(campo);
      if (error || !data) continue;
      data.forEach(d => {
        if (d[campo]) valoresUnicos.add(d[campo]);
      });
    }
  }
  
  const valorSel = document.getElementById('filtro-valor');
  [...valoresUnicos].sort().forEach(v => {
    const opt = document.createElement('option');
    opt.value = v; 
    opt.textContent = v;
    valorSel.appendChild(opt);
  });
});

// Filtrar y zoom autom√°tico
document.getElementById('btnFiltrar').onclick = async function() {
  const campo = document.getElementById('filtro-campo').value;
  const valor = document.getElementById('filtro-valor').value;
  
  if (!campo || !valor) {
    showMessage('Seleccione un atributo y un valor para filtrar.', 'error');
    return;
  }
  
  showLoading(this, 'Filtrando...');
  
  Object.keys(layers).forEach(k => { 
    if (layers[k]) map.removeLayer(layers[k]); 
  });

  let boundsList = [];
  
  // Si es filtro por contenedor, solo buscar en contenedores
  if (campo === 'contenedor') {
    let { data, error } = await supabase.from('contenedores').select('*').eq(campo, valor);
    if (error || !data || !data.length) {
      showMessage('No se encontr√≥ el contenedor especificado.', 'error');
      hideLoading(this, '<i class="fas fa-filter"></i> Aplicar');
      return;
    }

    const campoGeom = Object.keys(data[0]).find(k =>
      typeof data[0][k] === "object" && data[0][k] && data[0][k].type && Array.isArray(data[0][k].coordinates)
      || (typeof data[0][k] === "string" && /^(POINT|LINESTRING|POLYGON)/i.test(data[0][k]))
      || (typeof data[0][k] === "string" && data[0][k].includes("coordinates"))
    );
    
    if (!campoGeom) {
      showMessage('Error en la geometr√≠a del contenedor.', 'error');
      hideLoading(this, '<i class="fas fa-filter"></i> Aplicar');
      return;
    }

    let geojson = {
      type: "FeatureCollection",
      features: data.map(row => {
        let geometry;
        const geomField = row[campoGeom];
        if (typeof geomField === "string") {
          try { geometry = JSON.parse(geomField); }
          catch { geometry = WKTtoGeoJSON(geomField); }
        } else if (geomField && typeof geomField === "object" && geomField.type) {
          geometry = geomField;
        }
        if (!geometry || !geometry.type) return null;
        return { type: "Feature", geometry, properties: { ...row } };
      }).filter(f => f)
    };

    let layerFiltered = L.geoJSON(geojson, {
      pointToLayer: (feature, latlng) => 
        L.circleMarker(latlng, {
          ...estilos.contenedores,
          radius: 8,
          weight: 3,
          color: '#ff6b35'
        }),
      onEachFeature: (feature, layer) => {
        let props = feature.properties;
        let txt = Object.keys(props).map(k => `<b>${k}</b>: ${props[k]}`).join("<br>");
        layer.bindPopup(`<div style="max-width: 250px;">${txt}</div>`);
      }
    }).addTo(map);

    layers.contenedores = layerFiltered;
    
    if (layerFiltered.getBounds && layerFiltered.getBounds().isValid()) {
      map.fitBounds(layerFiltered.getBounds().pad(0.1));
    } else if (geojson.features.length > 0) {
      // Si es un punto, hacer zoom directo
      const coords = geojson.features[0].geometry.coordinates;
      map.setView([coords[1], coords[0]], 18);
    }
    
    showMessage(`Contenedor ${valor} localizado`, 'success');
    
  } else {
    // L√≥gica normal para otros filtros
    for (const [key, tabla] of Object.entries(tablasParaFiltros)) {
      let { data, error } = await supabase.from(tabla).select('*').eq(campo, valor);
      if (error || !data || !data.length) continue;

      const campoGeom = Object.keys(data[0]).find(k =>
        typeof data[0][k] === "object" && data[0][k] && data[0][k].type && Array.isArray(data[0][k].coordinates)
        || (typeof data[0][k] === "string" && /^(POINT|LINESTRING|POLYGON)/i.test(data[0][k]))
        || (typeof data[0][k] === "string" && data[0][k].includes("coordinates"))
      );
      
      if (!campoGeom) continue;

      let geojson = {
        type: "FeatureCollection",
        features: data.map(row => {
          let geometry;
          const geomField = row[campoGeom];
          if (typeof geomField === "string") {
            try { geometry = JSON.parse(geomField); }
            catch { geometry = WKTtoGeoJSON(geomField); }
          } else if (geomField && typeof geomField === "object" && geomField.type) {
            geometry = geomField;
          }
          if (!geometry || !geometry.type) return null;
          return { type: "Feature", geometry, properties: { ...row } };
        }).filter(f => f)
      };

      let layerFiltered = L.geoJSON(geojson, {
        style: key === "geocercas"
          ? feature => ({ 
              color: colorGeocerca(feature.properties.hor_frec), 
              weight: 3, 
              fillOpacity: 0.4,
              opacity: 0.8
            })
          : estilos[key] || {},
        pointToLayer: (feature, latlng) => (key === "contenedores")
          ? L.circleMarker(latlng, estilos.contenedores)
          : L.marker(latlng),
        onEachFeature: (feature, layer) => {
          let props = feature.properties;
          let txt = Object.keys(props).map(k => `<b>${k}</b>: ${props[k]}`).join("<br>");
          layer.bindPopup(`<div style="max-width: 250px;">${txt}</div>`);
        }
      }).addTo(map);

      layers[key] = layerFiltered;
      
      if (layerFiltered.getBounds && layerFiltered.getBounds().isValid()) {
        boundsList.push(layerFiltered.getBounds());
      }
    }

    if (boundsList.length) {
      let allBounds = boundsList.reduce((b, nb) => b.extend(nb), boundsList[0]);
      map.fitBounds(allBounds.pad(0.15));
      showMessage(`Filtro aplicado: ${boundsList.length} capas encontradas`, 'success');
    } else {
      showMessage('No se encontraron resultados para ese filtro.', 'error');
    }
  }
  
  hideLoading(this, '<i class="fas fa-filter"></i> Aplicar');
};

// Restablecer filtro
document.getElementById('btnResetFiltro').onclick = async function() {
  showLoading(this, 'Restableciendo...');
  
  // Remover todas las capas existentes
  Object.keys(layers).forEach(k => { 
    if (layers[k]) map.removeLayer(layers[k]); 
  });
  
  // Limpiar todos los marcadores de reportes
  markersReportes.forEach(m => map.removeLayer(m));
  markersReportes = [];
  
  // Limpiar marcador de b√∫squeda
  if (currentSearchMarker) {
    map.removeLayer(currentSearchMarker);
    currentSearchMarker = null;
  }
  
  // Limpiar input de b√∫squeda
  searchInput.value = '';
  clearSearch.classList.remove('show');
  hideSearchResults();
  
  // Recargar solo las capas
  await cargarCapas();
  
  // Asegurar que solo las geocercas est√©n visibles
  Object.keys(layers).forEach(k => {
    if (layers[k] && k !== 'geocercas') {
      map.removeLayer(layers[k]);
    }
  });
  
  // Desmarcar todos los checkboxes excepto geocercas
  document.getElementById("capa_contenedores").checked = false;
  document.getElementById("capa_barrido").checked = false;
  document.getElementById("capa_islas").checked = false;
  document.getElementById("capa_microrutas").checked = false;
  document.getElementById("capa_geocercas").checked = true;
  
  // Mostrar solo la leyenda de geocercas
  toggleLegend(true);
  
  // Ajustar el mapa a la extensi√≥n completa de las geocercas
  if (layers.geocercas && layers.geocercas.getBounds && layers.geocercas.getBounds().isValid()) {
    map.fitBounds(layers.geocercas.getBounds().pad(0.05));
  }
  
  // Limpiar controles de filtro
  document.getElementById('filtro-campo').value = "";
  limpiarSelect('filtro-valor', 'Seleccione valor');
  document.getElementById('filtro-valor-input').value = '';
  document.getElementById('toggle-input-mode').style.display = 'none';
  
  // Resetear a modo select
  inputMode = false;
  document.getElementById('filtro-valor').style.display = 'block';
  document.getElementById('filtro-valor-input').style.display = 'none';
  
  showMessage('Vista restablecida - Solo geocercas visibles', 'success');
  hideLoading(this, 'Reset');
};

// --- BOT√ìN DE UBICACI√ìN ---
const locationBtn = document.getElementById('locationBtn');

locationBtn.onclick = function() {
  if (!navigator.geolocation) {
    alert('Tu navegador no soporta geolocalizaci√≥n');
    return;
  }
  
  // Agregar clase de carga
  this.classList.add('loading');
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      
      // Centrar el mapa en la ubicaci√≥n del usuario
      map.setView([lat, lng], 16);
      
      // Crear un marcador en la ubicaci√≥n del usuario
      const userMarker = L.marker([lat, lng])
        .addTo(map)
        .bindPopup(`
          <div style="text-align: center;">
            <h4><i class="fas fa-map-marker-alt"></i> Tu ubicaci√≥n</h4>
            <p><strong>Lat:</strong> ${lat.toFixed(6)}<br>
            <strong>Lng:</strong> ${lng.toFixed(6)}</p>
          </div>
        `)
        .openPopup();
      
      // Remover clase de carga
      this.classList.remove('loading');
      this.innerHTML = '<i class="fas fa-location-arrow"></i>';
      
      // Opcional: remover el marcador despu√©s de unos segundos
      setTimeout(() => {
        map.removeLayer(userMarker);
      }, 5000);
    },
    (error) => {
      let errorMsg = 'Error obteniendo ubicaci√≥n';
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMsg = 'Permiso de ubicaci√≥n denegado';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMsg = 'Ubicaci√≥n no disponible';
          break;
        case error.TIMEOUT:
          errorMsg = 'Tiempo de espera agotado';
          break;
      }
      
      alert(errorMsg);
      
      // Remover clase de carga
      this.classList.remove('loading');
      this.innerHTML = '<i class="fas fa-location-arrow"></i>';
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 60000
    }
  );
};

// --- BUSCADOR DE DIRECCIONES ---
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const clearSearch = document.getElementById('clearSearch');

let searchTimeout;
let currentSearchMarker = null;
let selectedIndex = -1;

// Mostrar/ocultar bot√≥n de limpiar
searchInput.addEventListener('input', function() {
  const hasValue = this.value.length > 0;
  clearSearch.classList.toggle('show', hasValue);
  
  if (this.value.length > 2) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchPlaces(this.value);
    }, 500);
  } else {
    hideSearchResults();
  }
});

// Limpiar b√∫squeda
clearSearch.addEventListener('click', function() {
  searchInput.value = '';
  clearSearch.classList.remove('show');
  hideSearchResults();
  if (currentSearchMarker) {
    map.removeLayer(currentSearchMarker);
    currentSearchMarker = null;
  }
});

// Navegaci√≥n con teclado
searchInput.addEventListener('keydown', function(e) {
  const items = searchResults.querySelectorAll('.search-result-item');
  
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
    updateSelection(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    selectedIndex = Math.max(selectedIndex - 1, -1);
    updateSelection(items);
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (selectedIndex >= 0 && items[selectedIndex]) {
      selectSearchResult(items[selectedIndex]);
    }
  } else if (e.key === 'Escape') {
    hideSearchResults();
  }
});

// Ocultar resultados al hacer clic fuera
document.addEventListener('click', function(e) {
  if (!e.target.closest('.search-container')) {
    hideSearchResults();
  }
});

async function searchPlaces(query) {
  console.log('Buscando:', query);
  showSearchLoading();
  
  try {
    // Usar Nominatim con par√°metros espec√≠ficos para Ecuador
    const url = `https://nominatim.openstreetmap.org/search?` +
      `q=${encodeURIComponent(query)}&` +
      `format=json&` +
      `limit=5&` +
      `countrycodes=ec&` +
      `addressdetails=1&` +
      `extratags=1&` +
      `namedetails=1`;
    
    console.log('URL de b√∫squeda:', url);
    
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'GeoportalQuito/1.0'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const results = await response.json();
    console.log('Resultados:', results);
    
    displaySearchResults(results);
    
  } catch (error) {
    console.error('Error searching places:', error);
    showSearchError('Error en la b√∫squeda. Intenta de nuevo.');
  }
}

function showSearchLoading() {
  searchResults.innerHTML = `
    <div class="search-loading">
      <i class="fas fa-spinner fa-spin"></i> Buscando...
    </div>
  `;
  searchResults.classList.add('show');
  selectedIndex = -1;
}

function showSearchError(message = 'Error en la b√∫squeda') {
  searchResults.innerHTML = `
    <div class="search-no-results">
      <i class="fas fa-exclamation-triangle"></i> ${message}
    </div>
  `;
  searchResults.classList.add('show');
}

function displaySearchResults(results) {
  if (!results || results.length === 0) {
    searchResults.innerHTML = `
      <div class="search-no-results">
        <i class="fas fa-search"></i> No se encontraron resultados
      </div>
    `;
    searchResults.classList.add('show');
    return;
  }
  
  searchResults.innerHTML = results.map((result, index) => {
    const displayName = result.display_name || 'Ubicaci√≥n sin nombre';
    const parts = displayName.split(', ');
    const main = parts[0] || displayName;
    const sub = parts.slice(1, 3).join(', ') || 'Ecuador';
    
    return `
      <div class="search-result-item" data-lat="${result.lat}" data-lon="${result.lon}" data-index="${index}">
        <i class="fas fa-map-marker-alt result-icon"></i>
        <div class="result-text">
          <div class="result-main">${main}</div>
          <div class="result-sub">${sub}</div>
        </div>
      </div>
    `;
  }).join('');
  
  searchResults.classList.add('show');
  
  // Agregar event listeners
  searchResults.querySelectorAll('.search-result-item').forEach(item => {
    item.addEventListener('click', () => selectSearchResult(item));
    item.addEventListener('mouseenter', () => {
      selectedIndex = parseInt(item.dataset.index);
      updateSelection(searchResults.querySelectorAll('.search-result-item'));
    });
  });
  
  selectedIndex = -1;
}

function updateSelection(items) {
  items.forEach((item, index) => {
    item.classList.toggle('selected', index === selectedIndex);
  });
}

function selectSearchResult(item) {
  const lat = parseFloat(item.dataset.lat);
  const lon = parseFloat(item.dataset.lon);
  const text = item.querySelector('.result-main').textContent;
  
  console.log('Seleccionando:', { lat, lon, text });
  
  // Validar coordenadas
  if (isNaN(lat) || isNaN(lon)) {
    console.error('Coordenadas inv√°lidas:', { lat, lon });
    return;
  }
  
  // Actualizar input
  searchInput.value = text;
  hideSearchResults();
  
  // Remover marcador anterior si existe
  if (currentSearchMarker) {
    map.removeLayer(currentSearchMarker);
  }
  
  // Centrar mapa y agregar marcador
  map.setView([lat, lon], 15);
  
  currentSearchMarker = L.marker([lat, lon])
    .addTo(map)
    .bindPopup(`
      <div style="text-align: center; max-width: 200px;">
        <h4><i class="fas fa-map-marker-alt"></i> ${text}</h4>
        <small>Lat: ${lat.toFixed(6)}, Lng: ${lon.toFixed(6)}</small>
      </div>
    `)
    .openPopup();
}

function hideSearchResults() {
  searchResults.classList.remove('show');
  selectedIndex = -1;
}

// --- REPORTES CIUDADANOS ---
const btnReportes = document.getElementById('btnReportes');
const modalReporte = document.getElementById('modalReporte');
const cerrarModal = document.getElementById('cerrarModal');
const formReporte = document.getElementById('formReporte');
const inputLat = formReporte.querySelector('input[name="latitud"]');
const inputLon = formReporte.querySelector('input[name="longitud"]');

btnReportes.onclick = () => {
  modalReporte.style.display = 'flex';
  showMessage('Obteniendo ubicaci√≥n...', 'info');
  
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        inputLat.value = pos.coords.latitude.toFixed(7);
        inputLon.value = pos.coords.longitude.toFixed(7);
        showMessage('Ubicaci√≥n obtenida autom√°ticamente', 'success');
      },
      err => {
        showMessage('No se pudo obtener la ubicaci√≥n autom√°ticamente. Ingr√©sela manualmente.', 'error');
        inputLat.value = '';
        inputLon.value = '';
      }
    );
  } else {
    showMessage('GPS no disponible, ingrese las coordenadas manualmente.', 'error');
    inputLat.value = '';
    inputLon.value = '';
  }
};

cerrarModal.onclick = () => { 
  modalReporte.style.display = 'none'; 
  formReporte.reset(); 
  document.getElementById('msgReporte').textContent = '';
  document.getElementById('msgReporte').className = '';
};

// Establecer fecha actual
formReporte.fecha.value = new Date(Date.now() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0,16);

formReporte.onsubmit = async e => {
  e.preventDefault();
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  showLoading(submitBtn, 'Enviando...');
  showMessage("Enviando reporte...", 'info');
  
  const fd = new FormData(formReporte);
  const data = Object.fromEntries(fd.entries());
  data.latitud = parseFloat(data.latitud);
  data.longitud = parseFloat(data.longitud);
  if(data.fecha) data.fecha = new Date(data.fecha).toISOString();
  
  const { error } = await supabase
    .from('reportes_ciudadanos')
    .insert([data]);
    
  if (error) {
    showMessage('Error al enviar reporte: ' + error.message, 'error');
  } else {
    showMessage('¬°Reporte enviado exitosamente!', 'success');
    
    const marker = L.marker([data.latitud, data.longitud])
      .addTo(map)
      .bindPopup(
        `<div style="max-width: 250px;">
          <h4><i class="fas fa-clipboard-list"></i> Reporte Ciudadano</h4>
          <b>Fecha:</b> ${data.fecha?.slice(0,16) || ''}<br>
          <b>Nombre:</b> ${data.nombre_completo}<br>
          <b>Tipo:</b> ${data.tipo_problema}<br>
          <b>Descripci√≥n:</b> ${data.descripcion}
        </div>`
      ).openPopup();
      
    map.setView([data.latitud, data.longitud], 16);
    
    setTimeout(() => { 
      modalReporte.style.display = 'none'; 
      formReporte.reset(); 
      document.getElementById('msgReporte').textContent = '';
      document.getElementById('msgReporte').className = '';
    }, 2000);
  }
  
  hideLoading(submitBtn, originalText);
};

// Mostrar todos los reportes ciudadanos
let markersReportes = [];
document.getElementById('btnActualizarReporte').onclick = async function() {
  const originalText = this.innerHTML;
  showLoading(this, 'Cargando reportes...');
  
  markersReportes.forEach(m => map.removeLayer(m));
  markersReportes = [];
  
  const { data, error } = await supabase.from('reportes_ciudadanos').select('*');
  
  if (error) {
    showMessage('Error cargando reportes: ' + error.message, 'error');
    hideLoading(this, originalText);
    return;
  }
  
  if (!data || !data.length) {
    showMessage('No hay reportes registrados.', 'info');
    hideLoading(this, originalText);
    return;
  }
  
  data.forEach(r => {
    if(!r.latitud || !r.longitud) return;
    
    const marker = L.marker([r.latitud, r.longitud])
      .addTo(map)
      .bindPopup(
        `<div style="max-width: 250px;">
          <h4><i class="fas fa-clipboard-list"></i> Reporte Ciudadano</h4>
          <b>Fecha:</b> ${r.fecha ? r.fecha.slice(0,16).replace('T',' ') : ''}<br>
          <b>Nombre:</b> ${r.nombre_completo}<br>
          <b>Tel√©fono:</b> ${r.telefono}<br>
          <b>Tipo:</b> ${r.tipo_problema}<br>
          <b>Descripci√≥n:</b> ${r.descripcion || ''}
        </div>`
      );
    markersReportes.push(marker);
  });
  
  if (markersReportes.length > 0) {
    const group = L.featureGroup(markersReportes);
    map.fitBounds(group.getBounds().pad(0.2));
  }
  
  showMessage(`Se muestran ${data.length} reportes en el mapa.`, 'success');
  hideLoading(this, originalText);
};

// Cerrar modal al hacer clic fuera
modalReporte.addEventListener('click', function(e) {
  if (e.target === modalReporte) {
    modalReporte.style.display = 'none';
    formReporte.reset();
    document.getElementById('msgReporte').textContent = '';
    document.getElementById('msgReporte').className = '';
  }
});
</script>
</body>
</html>

